<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Be Still</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* All existing styles remain exactly the same */
        /* ... */
    </style>
</head>
<body class="home-mode">
    <!-- Add the missing DOM elements -->
    <div id="verse-text"></div>
    <div id="verse-reference"></div>
    <!-- All existing HTML elements remain exactly the same -->
    <script>
        // Add the missing page display functions
        function showHomePage() {
            document.body.className = 'home-mode';
        }

        function showFaqPage() {
            document.body.className = 'faq-mode';
        }

        // --- Data Management ---
        let versesESV = [];
        let versesNLT = [];
        let usedVerseIndices = new Set();
        let currentVerseIndex = -1;
        let selectedVersion = 'esv';

        // DOM Elements
        const verseTextElement = document.getElementById('verse-text');
        const verseReferenceElement = document.getElementById('verse-reference');
        const refreshButton = document.getElementById('refresh-button');
        const menuButton = document.getElementById('menu-button');
        const sideMenu = document.getElementById('side-menu');
        const modeSwitch = document.getElementById('mode-switch');
        const modeSwitchContainer = document.getElementById('mode-switch-container');
        const pauseSwitch = document.getElementById('pause-switch');
        const musicSwitch = document.getElementById('music-switch');
        const backgroundAudio = document.getElementById('background-audio');
        const versionSelectItems = document.querySelectorAll('#side-menu .version-select ul li');

        // Function to handle dark mode toggle
        function setDarkMode(enabled) {
            isDarkMode = enabled;
            if (enabled) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('darkMode', enabled);
        }

        // Function to parse CSV content
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const entry = {};
                headers.forEach((header, index) => {
                    entry[header.trim()] = values[index] ? values[index].replace(/^"|"$/g, '').trim() : '';
                });
                return entry;
            }).filter(entry => entry.Reference && entry.Verse);
        }

        // Function to load verses from CSV files
        async function loadVerses() {
            try {
                const [esvResponse, nltResponse] = await Promise.all([
                    fetch('data/versesESV.csv'),
                    fetch('data/versesNLT.csv')
                ]);
                
                const [esvText, nltText] = await Promise.all([
                    esvResponse.text(),
                    nltResponse.text()
                ]);

                versesESV = parseCSV(esvText);
                versesNLT = parseCSV(nltText);
                
                // Initialize with a random verse
                showNewVerse();
            } catch (error) {
                console.error('Error loading verses:', error);
                if (verseTextElement) {
                    verseTextElement.textContent = 'Error loading verses. Please try again later.';
                }
            }
        }

        function getAvailableVerses() {
            return selectedVersion === 'esv' ? versesESV : versesNLT;
        }

        function getRandomUnusedIndex(max) {
            if (usedVerseIndices.size >= max) {
                usedVerseIndices.clear(); // Reset when all verses have been used
            }
            
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * max);
            } while (usedVerseIndices.has(randomIndex));
            
            usedVerseIndices.add(randomIndex);
            return randomIndex;
        }

        function showNewVerse() {
            const verses = getAvailableVerses();
            if (!verses || verses.length === 0) {
                if (verseTextElement) verseTextElement.textContent = 'No verses available.';
                if (verseReferenceElement) verseReferenceElement.textContent = '';
                return;
            }

            const index = getRandomUnusedIndex(verses.length);
            const verse = verses[index];
            
            if (verseTextElement) verseTextElement.textContent = verse.Verse;
            if (verseReferenceElement) verseReferenceElement.textContent = `${verse.Reference} (${selectedVersion.toUpperCase()})`;
            
            if (autoAdvance) {
                resetInterval();
            }
        }

        // State Management
        let verseInterval = null;
        let isDarkMode = false;
        let isMenuOpen = false;
        let autoAdvance = true;
        let controlsVisible = false;
        let initialInteractionDone = false;
        let playMusicPreference = true;

        // Update version selection handler
        versionSelectItems.forEach(item => {
            item.addEventListener('click', () => {
                const newVersion = item.dataset.version;
                if (newVersion !== selectedVersion) {
                    selectedVersion = newVersion;
                    usedVerseIndices.clear(); // Reset used verses when changing versions
                    versionSelectItems.forEach(v => v.classList.remove('active'));
                    item.classList.add('active');
                    showNewVerse();
                }
                closeMenu();
            });
        });

        // Window load event handler
        window.onload = () => {
            const savedMode = localStorage.getItem('darkMode');
            setDarkMode(savedMode === 'true');
            if (modeSwitch) modeSwitch.checked = isDarkMode;

            const initialVersionItem = document.querySelector(`#side-menu .version-select li[data-version="${selectedVersion}"]`);
            if (initialVersionItem) initialVersionItem.classList.add('active');

            const savedAutoAdvance = localStorage.getItem('autoAdvance');
            if (savedAutoAdvance !== null) {
                autoAdvance = savedAutoAdvance === 'true';
            }
            if (pauseSwitch) pauseSwitch.checked = autoAdvance;

            const savedMusicPreference = localStorage.getItem('playMusic');
            if (savedMusicPreference !== null) {
                playMusicPreference = savedMusicPreference === 'true';
            }
            if (musicSwitch) musicSwitch.checked = playMusicPreference;

            if (playMusicPreference && backgroundAudio) {
                setTimeout(() => {
                    playAudio();
                }, 100);
            }

            loadVerses(); // Load verses from CSV files

            if (window.location.hash === '#faq') {
                showFaqPage();
            } else {
                showHomePage();
            }
        };
    </script>
</body>
</html>