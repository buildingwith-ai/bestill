<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Be Still</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* All existing styles remain unchanged */
    </style>
</head>
<body class="home-mode">
    <audio id="background-audio" src="ambient.mp3" loop></audio>

    <button id="menu-button" class="neumorphic-button">
        <div class="menu-icon"></div>
    </button>

    <label class="switch" id="mode-switch-container">
        <input type="checkbox" id="mode-switch">
        <span class="slider round"></span>
    </label>

    <div id="side-menu">
        <div class="menu-header">Menu</div>
        <ul>
            <li class="version-select">
                <p>Version Selection</p>
                <ul>
                    <li data-version="esv">English Standard (ESV)</li>
                    <li data-version="nlt">New Living (NLT)</li>
                </ul>
            </li>
            <li class="pause-toggle"> <p>Auto Advance</p>
                <label class="switch">
                    <input type="checkbox" id="pause-switch" checked>
                    <span class="slider round"></span>
                </label>
            </li>
            <li class="music-toggle"> <p>Background Music</p>
                <label class="switch">
                    <input type="checkbox" id="music-switch"> <span class="slider round"></span>
                </label>
            </li>
        </ul>
        <a href="#faq" class="faq-link">Frequently Asked Questions</a>
    </div>

    <div class="neumorphic-card" id="main-card">
        <div id="verse-content-container">
            <p id="verse-text" class="w-full">
                Loading verse...
            </p>
            <div id="verse-reference-container">
                <p id="verse-reference" class="font-semibold">
                    ---
                </p>
            </div>
        </div>
    </div>

    <div id="refresh-button-container">
        <button id="refresh-button" class="neumorphic-button" aria-label="New Verse">
            &rarr;
        </button>
    </div>

    <div id="faq-page" class="faq-page">
        <div class="faq-content">
            <a href="#" class="back-button" id="back-to-meditation">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 011.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
                Back to Meditation
            </a>
            <h1 class="faq-header">Frequently Asked Questions</h1>
            <div class="accordion-item">
                <div class="accordion-trigger">
                    How are verses selected?
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 icon">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 011.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="accordion-content">
                    Verses are carefully curated to focus on life application, wisdom, comfort, and guidance. Each verse is chosen for its ability to inspire reflection and meditation. Clicking the refresh button or enabling auto-advance displays a random verse from the selected version.
                </div>
            </div>
            <div class="accordion-item">
                 <div class="accordion-trigger">
                     What Bible versions are available?
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 icon">
                         <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 011.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                     </svg>
                 </div>
                 <div class="accordion-content">
                     The app currently offers two popular Bible translations:
                     <ul class="list-disc pl-5 mt-2">
                         <li>English Standard Version (ESV)</li>
                         <li>New Living Translation (NLT)</li>
                     </ul>
                     You can switch between them in the menu.
                 </div>
             </div>
             <div class="accordion-item">
                 <div class="accordion-trigger">
                     How does auto-advance work?
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 icon">
                         <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 011.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                     </svg>
                 </div>
                 <div class="accordion-content">
                     When auto-advance is enabled (using the toggle in the menu), the app will automatically display a new random verse after about 15 seconds. This allows for hands-free meditation. You can disable it if you prefer to get new verses manually using the refresh button.
                 </div>
             </div>
              <div class="accordion-item">
                 <div class="accordion-trigger">
                    Can I listen to music?
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 icon">
                         <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 011.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                     </svg>
                 </div>
                 <div class="accordion-content">
                    Yes! Ambient background music ("ambient.mp3") is set to play automatically. You can toggle it on or off using the "Background Music" switch in the menu. Your preference will be saved for your next visit.
                 </div>
             </div>
             <div class="accordion-item">
                 <div class="accordion-trigger">
                     Where is the verse reference?
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 icon">
                         <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 011.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                     </svg>
                 </div>
                 <div class="accordion-content">
                     The verse reference (e.g., John 3:16) appears below the main scripture text inside the card. It's designed to be slightly less prominent initially, allowing you to focus on the message first.
                 </div>
             </div>
              <div class="accordion-item">
                 <div class="accordion-trigger">
                     Why do the menu and dark mode buttons disappear?
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 icon">
                         <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 011.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                     </svg>
                 </div>
                 <div class="accordion-content">
                    To maintain a clean and focused reading experience, the menu button and dark mode switch appear only when you first interact with the screen (click or tap). If you then click or tap away from these buttons or the open menu, they will hide again until your next interaction.
                 </div>
             </div>
        </div>
    </div>

    <script>
        // --- Data: Scripture Verses ---
        const scriptures = {
            esv: [],
            nlt: []
        };

        // Function to parse CSV content
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const verses = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const firstComma = line.indexOf(',');
                const lastComma = line.lastIndexOf(',');
                
                if (firstComma === -1 || lastComma === -1) continue;
                
                const reference = line.substring(0, firstComma).replace(/^"|"$/g, '');
                const verse = line.substring(firstComma + 1, lastComma).replace(/^"|"$/g, '');
                
                if (reference && verse) {
                    verses.push({
                        reference: reference,
                        text: verse,
                        version: 'esv' // Will be overridden when loading
                    });
                }
            }
            
            return verses;
        }

        // Load verses from CSV files
        async function loadVerses() {
            try {
                const [esvResponse, nltResponse] = await Promise.all([
                    fetch('data/versesESV.csv'),
                    fetch('data/versesNLT.csv')
                ]);

                const [esvText, nltText] = await Promise.all([
                    esvResponse.text(),
                    nltResponse.text()
                ]);

                scriptures.esv = parseCSV(esvText).map(verse => ({ ...verse, version: 'esv' }));
                scriptures.nlt = parseCSV(nltText).map(verse => ({ ...verse, version: 'nlt' }));
                
                // Show initial verse once verses are loaded
                showNewVerse();
            } catch (error) {
                console.error('Error loading verses:', error);
                verseTextElement.textContent = 'Error loading verses. Please try refreshing the page.';
            }
        }

        // --- State ---
        let currentVerseIndex = -1;
        let verseInterval = null;
        let isDarkMode = false;
        let isMenuOpen = false;
        let selectedVersion = 'esv';
        let autoAdvance = true;
        let controlsVisible = false;
        let initialInteractionDone = false;
        let playMusicPreference = true;

        // --- DOM Elements ---
        const verseTextElement = document.getElementById('verse-text');
        const verseReferenceElement = document.getElementById('verse-reference');
        const refreshButton = document.getElementById('refresh-button');
        const refreshButtonContainer = document.getElementById('refresh-button-container');
        const modeSwitch = document.getElementById('mode-switch');
        const body = document.body;
        const modeSwitchContainer = document.getElementById('mode-switch-container');
        const menuButton = document.getElementById('menu-button');
        const sideMenu = document.getElementById('side-menu');
        const versionSelectItems = document.querySelectorAll('#side-menu .version-select li[data-version]');
        const pauseSwitch = document.getElementById('pause-switch');
        const faqLink = document.querySelector('#side-menu .faq-link');
        const faqPage = document.getElementById('faq-page');
        const backToMeditationLink = document.getElementById('back-to-meditation');
        const accordionTriggers = document.querySelectorAll('.accordion-trigger');
        const mainCard = document.getElementById('main-card');
        const verseContentContainer = document.getElementById('verse-content-container');
        const backgroundAudio = document.getElementById('background-audio');
        const musicSwitch = document.getElementById('music-switch');

        // --- Functions ---
        function getFilteredScriptures() {
            return scriptures[selectedVersion] || [];
        }

        function displayVerseByIndex(index) {
            const filteredScriptures = getFilteredScriptures();
            if (!filteredScriptures || filteredScriptures.length === 0) {
                verseTextElement.textContent = `Loading verses...`;
                verseReferenceElement.textContent = "";
                currentVerseIndex = -1;
                return;
            }
            if (index < 0 || index >= filteredScriptures.length) {
                console.error("Invalid index for displayVerseByIndex:", index);
                return;
            }
            currentVerseIndex = index;
            const verse = filteredScriptures[index];
            verseTextElement.textContent = verse.text;
            verseReferenceElement.textContent = `${verse.reference} (${verse.version.toUpperCase()})`;
        }

        function showRandomVerse() {
            const filteredScriptures = getFilteredScriptures();
            if (!filteredScriptures || filteredScriptures.length === 0) {
                displayVerseByIndex(-1);
                return;
            }
            if (filteredScriptures.length === 1) {
                displayVerseByIndex(0);
                return;
            }
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * filteredScriptures.length);
            } while (randomIndex === currentVerseIndex);
            displayVerseByIndex(randomIndex);
            if (autoAdvance) {
                resetInterval();
            }
        }
        const showNewVerse = showRandomVerse;

        function startInterval() {
            clearInterval(verseInterval);
            if (autoAdvance) {
                verseInterval = setInterval(showNewVerse, 15000);
            }
        }
        function resetInterval() {
            startInterval();
        }

        function setDarkMode(enabled) {
            isDarkMode = enabled;
            body.classList.toggle('dark', isDarkMode);
            if (faqPage.classList.contains('visible')) {
                updateFaqStyles();
            }
            localStorage.setItem('darkMode', isDarkMode);
        }
        function toggleDarkMode() {
            setDarkMode(!isDarkMode);
        }

        function setControlsVisibility(visible) {
            const show = visible && !faqPage.classList.contains('visible');
            controlsVisible = show;
            modeSwitchContainer.classList.toggle('visible', show);
            menuButton.classList.toggle('visible', show);
        }

        function openMenu() {
            if (!isMenuOpen) {
                isMenuOpen = true;
                sideMenu.classList.add('active');
                menuButton.classList.add('active');
            }
        }
        function closeMenu() {
            if (isMenuOpen) {
                isMenuOpen = false;
                sideMenu.classList.remove('active');
                menuButton.classList.remove('active');
            }
        }
        function toggleMenu() {
            if (isMenuOpen) closeMenu(); else openMenu();
        }

        // --- Music Functions ---
        function playAudio() {
            if (backgroundAudio) {
                backgroundAudio.play().catch(error => {
                    console.warn("Audio autoplay prevented:", error);
                    if (playMusicPreference) {
                        playMusicPreference = false;
                        musicSwitch.checked = false;
                        localStorage.setItem('playMusic', playMusicPreference);
                    }
                });
            }
        }

        function pauseAudio() {
            if (backgroundAudio) {
                backgroundAudio.pause();
            }
        }

        function toggleMusic() {
            playMusicPreference = musicSwitch.checked;
            if (playMusicPreference) {
                playAudio();
            } else {
                pauseAudio();
            }
            localStorage.setItem('playMusic', playMusicPreference);
        }

        // --- Page Toggle Functions ---
        function showFaqPage() {
            body.classList.add('faq-mode');
            faqPage.classList.add('visible');
            setControlsVisibility(false);
            closeMenu();
            window.location.hash = 'faq';
        }

        function showHomePage() {
            body.classList.remove('faq-mode');
            faqPage.classList.remove('visible');
            setControlsVisibility(true);
            window.location.hash = '';
        }

        // --- Event Listeners ---
        if (refreshButton) {
            refreshButton.addEventListener('click', (e) => {
                e.stopPropagation();
                showNewVerse();
            });
        }

        if (modeSwitch) modeSwitch.addEventListener('change', toggleDarkMode);
        if (menuButton) menuButton.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleMenu();
        });

        versionSelectItems.forEach(item => {
            item.addEventListener('click', () => {
                const newVersion = item.dataset.version;
                if (newVersion !== selectedVersion) {
                    selectedVersion = newVersion;
                    versionSelectItems.forEach(v => v.classList.remove('active'));
                    item.classList.add('active');
                    currentVerseIndex = -1;
                    showNewVerse();
                    resetInterval();
                }
                closeMenu();
            });
        });

        if (pauseSwitch) pauseSwitch.addEventListener('change', () => {
            autoAdvance = pauseSwitch.checked;
            localStorage.setItem('autoAdvance', autoAdvance);
            startInterval();
        });

        if (musicSwitch) musicSwitch.addEventListener('change', toggleMusic);

        if (faqLink) faqLink.addEventListener('click', (event) => {
            event.preventDefault();
            showFaqPage();
        });
        if (backToMeditationLink) backToMeditationLink.addEventListener('click', (event) => {
            event.preventDefault();
            showHomePage();
        });

        accordionTriggers.forEach(trigger => {
            trigger.addEventListener('click', () => {
                const content = trigger.nextElementSibling;
                const icon = trigger.querySelector('.icon');
                if (!content || !icon) return;
                const currentlyOpen = content.classList.contains('show');
                document.querySelectorAll('.accordion-content.show').forEach(c => c.classList.remove('show'));
                document.querySelectorAll('.icon.rotate').forEach(i => i.classList.remove('rotate'));
                if (!currentlyOpen) {
                    content.classList.add('show');
                    icon.classList.add('rotate');
                }
            });
        });

        document.addEventListener('click', (e) => {
            // If clicking the refresh button, don't do anything with the controls
            if (e.target.closest('#refresh-button')) {
                return;
            }

            if (!initialInteractionDone) {
                initialInteractionDone = true;
                setControlsVisibility(true);
                if (playMusicPreference && backgroundAudio && backgroundAudio.paused) {
                    playAudio();
                }
                return;
            }

            if (controlsVisible) {
                const isControlElement = e.target.closest('#menu-button') ||
                    e.target.closest('#mode-switch-container') ||
                    (isMenuOpen && e.target.closest('#side-menu'));

                if (!isControlElement) {
                    if (isMenuOpen) {
                        toggleMenu();
                    }
                    setControlsVisibility(false);
                    initialInteractionDone = false;
                }
            }
        });

        // --- Initial Load ---
        window.onload = async () => {
            // Load verses first
            await loadVerses();

            const savedMode = localStorage.getItem('darkMode');
            setDarkMode(savedMode === 'true');
            if (modeSwitch) modeSwitch.checked = isDarkMode;

            const initialVersionItem = document.querySelector(`#side-menu .version-select li[data-version="${selectedVersion}"]`);
            if (initialVersionItem) initialVersionItem.classList.add('active');

            const savedAutoAdvance = localStorage.getItem('autoAdvance');
            if (savedAutoAdvance !== null) {
                autoAdvance = savedAutoAdvance === 'true';
            }
            if (pauseSwitch) pauseSwitch.checked = autoAdvance;

            const savedMusicPreference = localStorage.getItem('playMusic');
            if (savedMusicPreference !== null) {
                playMusicPreference = savedMusicPreference === 'true';
            }
            if (musicSwitch) musicSwitch.checked = playMusicPreference;

            if (playMusicPreference && backgroundAudio) {
                setTimeout(() => {
                    playAudio();
                }, 100);
            }

            startInterval();

            if (window.location.hash === '#faq') {
                showFaqPage();
            } else {
                showHomePage();
            }
        };
    </script>
</body>
</html>