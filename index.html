<!DOCTYPE html>
<html lang="en">
[Previous HTML content remains exactly the same until the script section]

<script>
    // --- State Management ---
    let versesESV = [];
    let versesNLT = [];
    let currentVerseIndex = -1;
    let verseInterval = null;
    let isDarkMode = false;
    let isMenuOpen = false;
    let selectedVersion = 'esv';
    let autoAdvance = true;
    let controlsVisible = false;
    let initialInteractionDone = false;
    let playMusicPreference = true;

    // --- DOM Elements ---
    const verseTextElement = document.getElementById('verse-text');
    const verseReferenceElement = document.getElementById('verse-reference');
    const refreshButton = document.getElementById('refresh-button');
    const menuButton = document.getElementById('menu-button');
    const sideMenu = document.getElementById('side-menu');
    const modeSwitch = document.getElementById('mode-switch');
    const modeSwitchContainer = document.getElementById('mode-switch-container');
    const pauseSwitch = document.getElementById('pause-switch');
    const musicSwitch = document.getElementById('music-switch');
    const backgroundAudio = document.getElementById('background-audio');
    const versionSelectItems = document.querySelectorAll('#side-menu .version-select ul li');
    const faqLink = document.querySelector('#side-menu .faq-link');
    const faqPage = document.getElementById('faq-page');
    const backToMeditationLink = document.getElementById('back-to-meditation');
    const accordionTriggers = document.querySelectorAll('.accordion-trigger');

    // --- Functions ---
    function parseCSV(csv) {
        const lines = csv.split('\n');
        const verses = [];
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // Split on the last comma (which separates verse from topics)
            const lastCommaIndex = line.lastIndexOf(',');
            if (lastCommaIndex === -1) continue;
            
            const beforeTopics = line.substring(0, lastCommaIndex);
            
            // Find the first comma to separate reference from verse
            const firstCommaIndex = beforeTopics.indexOf(',');
            if (firstCommaIndex === -1) continue;
            
            const reference = beforeTopics.substring(0, firstCommaIndex).replace(/^"|"$/g, '');
            const verse = beforeTopics.substring(firstCommaIndex + 1).replace(/^"|"$/g, '');
            
            verses.push({
                reference: reference,
                verse: verse
            });
        }
        
        return verses;
    }

    async function loadVerses() {
        try {
            const [esvResponse, nltResponse] = await Promise.all([
                fetch('data/versesESV.csv'),
                fetch('data/versesNLT.csv')
            ]);
            
            const [esvText, nltText] = await Promise.all([
                esvResponse.text(),
                nltResponse.text()
            ]);

            versesESV = parseCSV(esvText);
            versesNLT = parseCSV(nltText);
            
            showNewVerse();
        } catch (error) {
            console.error('Error loading verses:', error);
            verseTextElement.textContent = 'Error loading verses. Please try again later.';
        }
    }

    function getRandomVerse() {
        const verses = selectedVersion === 'esv' ? versesESV : versesNLT;
        if (!verses || verses.length === 0) return null;
        
        let randomIndex;
        do {
            randomIndex = Math.floor(Math.random() * verses.length);
        } while (randomIndex === currentVerseIndex);
        
        currentVerseIndex = randomIndex;
        return verses[randomIndex];
    }

    function showNewVerse() {
        const verse = getRandomVerse();
        if (!verse) {
            verseTextElement.textContent = 'No verses available.';
            verseReferenceElement.textContent = '';
            return;
        }
        
        verseTextElement.textContent = verse.verse;
        verseReferenceElement.textContent = `${verse.reference} (${selectedVersion.toUpperCase()})`;
        
        if (autoAdvance) {
            resetInterval();
        }
    }

    function resetInterval() {
        if (verseInterval) {
            clearInterval(verseInterval);
        }
        if (autoAdvance) {
            verseInterval = setInterval(showNewVerse, 15000);
        }
    }

    function setDarkMode(enabled) {
        isDarkMode = enabled;
        document.body.classList.toggle('dark', enabled);
        localStorage.setItem('darkMode', enabled);
    }

    function showHomePage() {
        faqPage.classList.remove('visible');
        document.body.classList.remove('faq-mode');
    }

    function showFaqPage() {
        faqPage.classList.add('visible');
        document.body.classList.add('faq-mode');
    }

    function setControlsVisibility(visible) {
        controlsVisible = visible;
        modeSwitchContainer.classList.toggle('visible', visible);
        menuButton.classList.toggle('visible', visible);
    }

    function toggleMenu() {
        isMenuOpen = !isMenuOpen;
        sideMenu.classList.toggle('active', isMenuOpen);
        menuButton.classList.toggle('active', isMenuOpen);
    }

    function playAudio() {
        if (backgroundAudio) {
            backgroundAudio.play().catch(error => {
                console.warn("Audio autoplay prevented:", error);
            });
        }
    }

    function pauseAudio() {
        if (backgroundAudio) {
            backgroundAudio.pause();
        }
    }

    // --- Event Listeners ---
    if (refreshButton) {
        refreshButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent the click from bubbling to document
            showNewVerse();
        });
    }

    if (modeSwitch) {
        modeSwitch.addEventListener('change', () => setDarkMode(modeSwitch.checked));
    }

    if (menuButton) {
        menuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu();
        });
    }

    versionSelectItems.forEach(item => {
        item.addEventListener('click', () => {
            const newVersion = item.dataset.version;
            if (newVersion !== selectedVersion) {
                selectedVersion = newVersion;
                versionSelectItems.forEach(v => v.classList.remove('active'));
                item.classList.add('active');
                showNewVerse();
            }
            toggleMenu();
        });
    });

    if (pauseSwitch) {
        pauseSwitch.addEventListener('change', () => {
            autoAdvance = pauseSwitch.checked;
            localStorage.setItem('autoAdvance', autoAdvance);
            resetInterval();
        });
    }

    if (musicSwitch) {
        musicSwitch.addEventListener('change', () => {
            playMusicPreference = musicSwitch.checked;
            if (playMusicPreference) {
                playAudio();
            } else {
                pauseAudio();
            }
            localStorage.setItem('playMusic', playMusicPreference);
        });
    }

    if (faqLink) {
        faqLink.addEventListener('click', (e) => {
            e.preventDefault();
            showFaqPage();
            toggleMenu();
        });
    }

    if (backToMeditationLink) {
        backToMeditationLink.addEventListener('click', (e) => {
            e.preventDefault();
            showHomePage();
        });
    }

    accordionTriggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
            const content = trigger.nextElementSibling;
            const icon = trigger.querySelector('.icon');
            const isOpen = content.classList.contains('show');
            
            document.querySelectorAll('.accordion-content.show').forEach(c => c.classList.remove('show'));
            document.querySelectorAll('.icon.rotate').forEach(i => i.classList.remove('rotate'));
            
            if (!isOpen) {
                content.classList.add('show');
                icon.classList.add('rotate');
            }
        });
    });

    document.addEventListener('click', (e) => {
        // Don't process refresh button clicks here
        if (e.target.closest('#refresh-button')) {
            return;
        }

        if (!initialInteractionDone) {
            initialInteractionDone = true;
            setControlsVisibility(true);
            if (playMusicPreference && backgroundAudio && backgroundAudio.paused) {
                playAudio();
            }
            return;
        }

        if (controlsVisible) {
            const isControlElement = e.target.closest('#menu-button') ||
                e.target.closest('#mode-switch-container') ||
                (isMenuOpen && e.target.closest('#side-menu'));

            if (!isControlElement) {
                if (isMenuOpen) {
                    toggleMenu();
                }
                setControlsVisibility(false);
                initialInteractionDone = false;
            }
        }
    });

    // --- Initialize ---
    window.onload = () => {
        const savedMode = localStorage.getItem('darkMode');
        setDarkMode(savedMode === 'true');
        if (modeSwitch) modeSwitch.checked = isDarkMode;

        const initialVersionItem = document.querySelector(`#side-menu .version-select li[data-version="${selectedVersion}"]`);
        if (initialVersionItem) initialVersionItem.classList.add('active');

        const savedAutoAdvance = localStorage.getItem('autoAdvance');
        if (savedAutoAdvance !== null) {
            autoAdvance = savedAutoAdvance === 'true';
        }
        if (pauseSwitch) pauseSwitch.checked = autoAdvance;

        const savedMusicPreference = localStorage.getItem('playMusic');
        if (savedMusicPreference !== null) {
            playMusicPreference = savedMusicPreference === 'true';
        }
        if (musicSwitch) musicSwitch.checked = playMusicPreference;

        if (playMusicPreference && backgroundAudio) {
            setTimeout(playAudio, 100);
        }

        loadVerses();

        if (window.location.hash === '#faq') {
            showFaqPage();
        } else {
            showHomePage();
        }
    };
</script>
</body>
</html>