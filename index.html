<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Be Still</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* All previous CSS remains exactly the same */
    </style>
</head>
<body class="home-mode">
    <!-- All previous HTML remains exactly the same -->
    <script>
        // --- Data: Scripture Verses ---
        let versesESV = [];
        let versesNLT = [];

        // Fetch and parse CSV files
        async function fetchVerses() {
            try {
                const [esvResponse, nltResponse] = await Promise.all([
                    fetch('data/versesESV.csv'),
                    fetch('data/versesNLT.csv')
                ]);

                const esvText = await esvResponse.text();
                const nltText = await nltResponse.text();

                versesESV = parseCSV(esvText);
                versesNLT = parseCSV(nltText);

                // Show initial verse once data is loaded
                showNewVerse();
            } catch (error) {
                console.error('Error loading verses:', error);
                verseTextElement.textContent = 'Error loading verses. Please try again later.';
            }
        }

        function parseCSV(csv) {
            const lines = csv.split('\n');
            const verses = [];
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const [reference, verse] = lines[i].split(',');
                if (reference && verse) {
                    verses.push({
                        reference: reference.trim(),
                        text: verse.trim().replace(/^"|"$/g, ''),
                        version: 'esv' // or 'nlt' depending on source
                    });
                }
            }
            
            return verses;
        }

        // --- State ---
        let currentVerseIndex = -1;
        let verseInterval = null;
        let isDarkMode = false;
        let isMenuOpen = false;
        let selectedVersion = 'esv';
        let autoAdvance = true;
        let controlsVisible = false;
        let initialInteractionDone = false;
        let playMusicPreference = true;

        // --- DOM Elements ---
        const verseTextElement = document.getElementById('verse-text');
        const verseReferenceElement = document.getElementById('verse-reference');
        const refreshButton = document.getElementById('refresh-button');
        const refreshButtonContainer = document.getElementById('refresh-button-container');
        const modeSwitch = document.getElementById('mode-switch');
        const body = document.body;
        const modeSwitchContainer = document.getElementById('mode-switch-container');
        const menuButton = document.getElementById('menu-button');
        const sideMenu = document.getElementById('side-menu');
        const versionSelectItems = document.querySelectorAll('#side-menu .version-select li[data-version]');
        const pauseSwitch = document.getElementById('pause-switch');
        const faqLink = document.querySelector('#side-menu .faq-link');
        const faqPage = document.getElementById('faq-page');
        const backToMeditationLink = document.getElementById('back-to-meditation');
        const accordionTriggers = document.querySelectorAll('.accordion-trigger');
        const mainCard = document.getElementById('main-card');
        const verseContentContainer = document.getElementById('verse-content-container');
        const backgroundAudio = document.getElementById('background-audio');
        const musicSwitch = document.getElementById('music-switch');

        // --- Functions ---
        function getFilteredScriptures() {
            return selectedVersion === 'esv' ? versesESV : versesNLT;
        }

        // All other functions remain exactly the same

        // --- Event Listeners ---
        // All previous event listeners remain exactly the same

        document.addEventListener('click', (e) => {
            // If clicking the refresh button, don't do anything
            if (e.target.closest('#refresh-button')) {
                return;
            }

            if (!initialInteractionDone) {
                initialInteractionDone = true;
                setControlsVisibility(true);
                if (playMusicPreference && backgroundAudio && backgroundAudio.paused) {
                    playAudio();
                }
                return;
            }

            if (controlsVisible) {
                const isControlElement = e.target.closest('#menu-button') ||
                    e.target.closest('#mode-switch-container') ||
                    (isMenuOpen && e.target.closest('#side-menu'));

                if (!isControlElement) {
                    if (isMenuOpen) {
                        toggleMenu();
                    }
                    setControlsVisibility(false);
                    initialInteractionDone = false;
                }
            }
        });

        // --- Initial Load ---
        window.onload = () => {
            const savedMode = localStorage.getItem('darkMode');
            setDarkMode(savedMode === 'true');
            if (modeSwitch) modeSwitch.checked = isDarkMode;

            const initialVersionItem = document.querySelector(`#side-menu .version-select li[data-version="${selectedVersion}"]`);
            if (initialVersionItem) initialVersionItem.classList.add('active');

            const savedAutoAdvance = localStorage.getItem('autoAdvance');
            if (savedAutoAdvance !== null) {
                autoAdvance = savedAutoAdvance === 'true';
            }
            if (pauseSwitch) pauseSwitch.checked = autoAdvance;

            const savedMusicPreference = localStorage.getItem('playMusic');
            if (savedMusicPreference !== null) {
                playMusicPreference = savedMusicPreference === 'true';
            }
            if (musicSwitch) musicSwitch.checked = playMusicPreference;

            if (playMusicPreference && backgroundAudio) {
                setTimeout(() => {
                    playAudio();
                }, 100);
            }

            // Load verses first, then show initial verse
            fetchVerses();
            startInterval();

            if (window.location.hash === '#faq') {
                showFaqPage();
            } else {
                showHomePage();
            }
        };
    </script>
</body>
</html>